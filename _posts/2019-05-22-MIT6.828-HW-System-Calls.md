---
layout: post
title: "MIT6.828 操作系统 HW:System Calls"
comments: true
description: "MIT6.828 操作系统 HW:System Calls"
keywords: "OS, assembly, c"
---

## 作业要求

这个作业是向 xv6 中添加一个系统调用，这个系统调用获取当前的 UTC 时间，并返回这个时间。在实现过程中，将会使用到帮助函数 `cmostime()`，这个函数需要一个 `struct rtcdate` 结构体指针作为参数。

为了检验这个系统调用的正确性，我们选择写一个简单的 c 语言程序 `date.c`:

```
#include "types.h"
#include "user.h"
#include "date.h"

int
main(int argc, char *argv[])
{
  struct rtcdate r;

  if (date(&r)) {
    printf(2, "date failed\n");
    exit();
  }

  // your code to print the time in any format you like...

  exit();
}
```
然后将这个程序加入到 shell 中

## 作业实现

首先在 `sysproc.c` 中添加如下代码:

```
/*
 * 根据homework提供的部分代码来看, data系统调用应该需要一个4字节的指针作为参数
 * 为了方便, 我们可以使用argint()来获取这个整数, 然后将其强制转换为struct rtcdate类型的指针
 * 返回 1 说明失败, 返回 0 说明成功
 */
int sys_date(void)
{
  int temp;
  if (argint(0, &temp) < 0)
    return 1;
  cmostime((struct rtcdate *)temp);
  return 0;
}
```

从 `date.c` 示范代码中可以看到，`data()` 系统调用接受了一个 `struct rtcdate` 结构体指针作为参数，这里为了方便，使用 `argint()` 来获取这个指针值，获取到后通过类型转换将这个值转换成 `struct rtcdate` 类型的指针，并把这个指针传入 `cmostime()` 函数。