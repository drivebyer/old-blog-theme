---
layout: post
title: "MIT6.828 操作系统 Lab2: Memory Management"
comments: true
description: "MIT6.828 操作系统 Lab2: Memory Management"
keywords: "Lab, 6.828, MIT"
---

## 介绍

这个实验的目的是向 JOS 中添加内存管理，包括两部分内容：

1. physical memory allocator for the kernel，粒度为 4096B，一页(Page)的大小，我们的任务就是选用适当的数据结构来记录 Physical Page 的分配情况和有多少进程在共享这些 Physical Page。

2. virtual memory, which maps the virtual addresses used by kernel and user software to addresses in physical memory，映射通过 [MMU](https://en.wikipedia.org/wiki/Memory_management_unit) 和 [Page table](https://en.wikipedia.org/wiki/Page_table) 共同完成。

## 准备

在实验之前，先看下面五个文件：

1. inc/memlayout.h
2. kern/pmap.c
3. kern/pmap.h
4. kern/kclock.h
5. kern/kclock.c

> **memlayout.h** describes the layout of the virtual address space that you must implement by modifying **pmap.c**. The code in **pmap.c** needs to read this device hardware in order to figure out how much physical memory there is, but that part of the code is done for you: you do not need to know the details of how the CMOS hardware works.

> **memlayout.h** and **pmap.h** define the **PageInfo** structure that you'll use to keep track of which pages of physical memory are free.

> **kclock.c** and **kclock.h** manipulate the PC's battery-backed clock and CMOS RAM hardware, in which the BIOS records the amount of physical memory the PC contains, among other things.

> Pay particular attention to **memlayout.h** and **pmap.h**, since this lab requires you to use and understand many of the definitions they contain. You may want to review **inc/mmu.h**, too, as it also contains a number of definitions that will be useful for this lab.

下面是 inc/memlayout.h 中设置的虚拟内存布局图例:

```
                                                Permissions
                                                kernel/user
        4 Gig -> +------------------------------+
                 |                              | RW/--
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                 :            ...               :
                 |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~| RW/--
                 |                              | RW/--
                 |   Remapped Physical Memory   | RW/--
                 |                              | RW/--
    KERNBASE, -> +------------------------------+ 0xf0000000  -----------------+
    KSTACKTOP    |     CPU0's Kernel Stack      | RW/-- KSTKSIZE(8*PGSIZE)     |
                 | - - - - - - - - - - - - - - -|                              |
                 |      Invalid Memory (*)      | --/-- KSTKGAP(8*PGSIZE)      |
                 +------------------------------+                              |
                 |     CPU1's Kernel Stack      | RW/-- KSTKSIZE               |
                 | - - - - - - - - - - - - - - -|                         PTSIZE(1024*4096B
                 |      Invalid Memory (*)      | --/-- KSTKGAP                |
                 +------------------------------+                              |
                 :              .               :                              |
      MMIOLIM -> +------------------------------+ 0xefc00000  -----------------+
                 |       Memory-mapped I/O      | RW/--  PTSIZE
ULIM,MMIOBASE -> +------------------------------+ 0xef800000      
                 |  Cur. Page Table (User R-)   | R-/R-  PTSIZE    +-------+-----+-----+
         UVPT -> +------------------------------+ 0xef400000 ----> | 0x3BD | 0x0 | 0x0 |
                 |          RO PAGES            | R-/R-  PTSIZE    +-------+-----+-----+
       UPAGES -> +------------------------------+ 0xef000000
                 |           RO ENVS            | R-/R-  PTSIZE
   UTOP,UENVS -> +------------------------------+ 0xeec00000
   UXSTACKTOP -> |     User Exception Stack     | RW/RW  PGSIZE(4096B)
                 +------------------------------+ 0xeebff000
                 |       Empty Memory (*)       | --/--  PGSIZE
    USTACKTOP -> +------------------------------+ 0xeebfe000
                 |      Normal User Stack       | RW/RW  PGSIZE
                 +------------------------------+ 0xeebfd000
                 |                              |
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                 .                              .
                 |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|
                 |     Program Data & Heap      |
        UTEXT -> +------------------------------+ 0x00800000  ------+
                 |                              |                   |
       PFTEMP -> |       Empty Memory (*)       |                 PTSIZE
                 |                              |                   |
        UTEMP -> +------------------------------+ 0x00400000  ------+
                 |       Empty Memory (*)       |                   |
                 | - - - - - - - - - - - - - - -|                   |
                 |  User STAB Data (optional)   |                 PTSIZE
    USTABDATA -> +------------------------------+ 0x00200000        |
                 |       Empty Memory (*)       |                   |
            0 -> +------------------------------+             ------+

 (*) Note: The kernel ensures that "Invalid Memory" is *never* mapped.
     "Empty Memory" is normally unmapped, but user programs may map pages
     there if desired.  JOS user programs map pages temporarily at UTEMP.
```

下面是物理内存布局：

```
 +---------------+ <- oxFFFFFFFF (4GB)
 |    32-bit     |
 | memory mapped |
 |    devices    |
 +---------------+
 |               |
 |    unused     |
 |               |
 +---------------+ <- depends on amont of RAM
 |               |
 |    exetend    |
 |    memory     |
 +---------------+ <- 0x00100000 (1MB EXTPHYSMEM) Begin of kernel
 |    BIOS ROM   |
 +---------------+ <- 0x000F0000 (960KB)
 | 16-bot devices|
 +---------------+ <- 0x000C0000 (768KB)
 |  VGA display  |
 +---------------+ <- 0x000A0000 (640KB IOPHYSMEM)  -------------+
 |               |                                               |
 +---------------+ <- 0x00007c00 begin of bootloader        Low Memory 
 |    stack      |                                               |
 +---------------+ <- 0x00000000   ------------------------------+
```


## Part1: Physical Page Management

在 xv6 中，使用 **struct run** 结构体来描述物理页，而在 JOS 中，则使用 **struct PageInfo** 来描述，并且与 xv6 不同的是，**struct PageInfo** 没有内嵌到 free page 中。



