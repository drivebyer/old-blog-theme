---
layout: post
title: "MIT6.828 操作系统 Lab3: User Environment"
comments: true
description: "MIT6.828 操作系统 Lab3: User Environment"
keywords: "OS, assembly, c"
---

&nbsp;

## 一、Introduction

___

In this lab you will implement the basic kernel facilities required to get a protected user-mode environment (i.e., "process") running. You will enhance the JOS kernel to set up the data structures to keep track of user environments, create a single user environment, load a program image into it, and start it running. You will also make the JOS kernel capable of handling any system calls the user environment makes and handling any other exceptions it causes.

Note: In this lab, the terms **environment** and **process** are interchangeable - both refer to an abstraction that allows you to run a program. We introduce the term "environment" instead of the traditional term "process" in order to stress the point that JOS environments and UNIX processes provide different interfaces, and do not provide the same semantics.

### 3.1、Getting Started

```
linux> cd ~/6.828/lab
linux> git commit -m "change"
linux> git pull
linux> git checkout -b lab3 origin/lab3
linux> git checkout lab1
linux> git merge lab3 
```

由于我是在 lab1 分之上做的开发，所以合并前需要切换到 lab1 分支。

下面是本实验需要用到的一些文件说明，大致浏览一下即可：

1.  **inc/env.h**  Public definitions for user-mode environments
2.  **trap.h**  Public definitions for trap handling
3.  **syscall.h**  Public definitions for system calls from user environments to the kernel
4.  **lib.h**  Public definitions for the user-mode support library
5.  **kern/env.h**  Kernel-private definitions for user-mode environments
6.  **env.c**  Kernel code implementing user-mode environments
7.  **trap.h**  Kernel-private trap handling definitions
8.  **trap.c**  Trap handling code
9.  **trapentry.S**  Assembly-language trap handler entry-points
10. **syscall.h**  Kernel-private definitions for system call handling
11. **syscall.c**  System call implementation code
12. **lib/Makefrag**  Makefile fragment to build user-mode library, obj/lib/libjos.a
13. **entry.S**  Assembly-language entry-point for user environments
14. **libmain.c**  User-mode library setup code called from entry.S
15. **syscall.c**  User-mode system call stub functions
16. **console.c**  User-mode implementations of putchar and getchar, providing console I/O
17. **exit.c**  User-mode implementation of exit
18. **panic.c**  User-mode implementation of panic
19. **user/**  Various test programs to check kernel lab 3 code

### 3.2、Inline Assembly

这个 lab 里很多地方会使用到内联汇编，下面是一些参考资料：

1. [Inline assembly for x86 in Linux](https://www.ibm.com/developerworks/linux/library/l-ia/index.html)
2. [Brennan's Guide to Inline Assembly](http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html)
3. [GCC Inline Assembly HOWTO](http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html)
4. [内联汇编初探](https://wuyang.me/2019/%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96%E5%88%9D%E6%8E%A2/)

&nbsp;

## 二、Part A: User Environment and Exception Handling

___

The new include file **inc/env.h** contains basic definitions for user environments in JOS. Read it now. The kernel uses the **Env** data structure to keep track of each user environment. In this lab you will initially create **just one environment**, but you will need to design the JOS kernel to **support multiple environments**; lab 4 will take advantage of this feature by allowing a user environment to fork other environments.

As you can see in kern/env.c, the kernel maintains three main global variables pertaining to environments:

```c
struct Env *envs = NULL;		// All environments
struct Env *curenv = NULL;		// The current env
static struct Env *env_free_list;	// Free environment list
```























&nbsp;

## 三、Part B: Page Faults，Breakpoints Exceptions and System Calls

___
