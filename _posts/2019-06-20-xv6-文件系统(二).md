---
layout: post
title: "xv6: æ–‡ä»¶ç³»ç»Ÿ(äºŒ)"
comments: true
description: "xv6: æ–‡ä»¶ç³»ç»Ÿ(äºŒ)"
keywords: "OS, xv6, c, file system"
---

&nbsp;

## ä¸€ã€ä»‹ç»

___

è¿™ç¯‡æ–‡ç« çºªå½•ä¸‹æˆ‘å­¦ä¹  xv6 æ–‡ä»¶ç³»ç»Ÿï¼ˆä»¥åç®€ç§°xv6fsï¼‰çš„è¿‡ç¨‹ï¼Œå…ˆå¯¼ç¯‡: [xv6: æ–‡ä»¶ç³»ç»Ÿ(ä¸€)](https://wuyang.me/2019/xv6-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F(%E4%B8%80)/)ã€‚

xv6fs ç®—æ˜¯æ•´ä¸ª xv6 æºç ä¸­çš„é‡å¤´æˆï¼Œæ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿå¾ˆæŠ½è±¡ï¼Œå¯¹äºæˆ‘è¿™ç§ Unix å°ç™½ï¼Œå¤´ä¸€æ¬¡é˜…è¯»è¿™ç§ä»£ç ååˆ†çš„æ‡µã€‚ç»è¿‡åå¤é˜…è¯»ï¼Œç»ˆäºé¢†æ‚Ÿåˆ°äº†ä¸€ç‚¹å…¶ä¸­çš„å¥¥å¦™ã€‚

ä¸‹é¢æ˜¯ xv6fs é€»è¾‘ä¸Šçš„åˆ†å±‚å›¾ï¼š

```
+------------------+
|  File Descriptor |
+------------------+
|     Pathname     |
+------------------+
|     Directory    |
+------------------+
|      Inode       |
+------------------+
|     Logging      |
+------------------+
|   Buffer Cache   |
+------------------+
|       Disk       |
+------------------+
```

ä¸‹é¢ä»ä¸‹å‘ä¸Šä¾æ¬¡ä»‹ç»ã€‚

&nbsp;

## äºŒã€Disk

___

xv6 ä¸­ç£ç›˜é©±åŠ¨ä¸»è¦ç”± [ide.c](https://github.com/mit-pdos/xv6-public/blob/master/ide.c) æ–‡ä»¶å®ç°ã€‚è¿™ä¸ªæ–‡ä»¶ä¸‹æœ‰ä»¥ä¸‹å˜é‡å’Œå‡½æ•°:

```c
static struct spinlock idelock;
static struct buf *idequeue;
static int havedisk1;

static int idewait(int checkerr);
static void idestart(struct buf *b);
void iderw(struct buf *b);
void ideintr(void);
void ideinit(void);
```

å…¶ä¸­æš´éœ²ç»™ buffer cache å±‚çš„æ˜¯å‡½æ•° **iderw()**ã€‚æ­¤å‡½æ•°å‘èµ·å¯¹ç£ç›˜çš„è¯»å†™ **idestart()**ã€‚å› ä¸ºç£ç›˜æ“ä½œå¾ˆè€—æ—¶ï¼Œéšå³è¿›å…¥ç¡çœ çŠ¶æ€:

```c
void
iderw(struct buf *b)
{
  ...
  if(idequeue == b)
    idestart(b);
  while((b->flags & (B_VALID|B_DIRTY)) != B_VALID){
    sleep(b, &idelock);
  }
  ...
}
```

ç­‰åˆ°ç£ç›˜çš„è¯»å†™å®Œæˆåï¼Œä¼šæ”¶åˆ°ä¸€ä¸ªæ¥è‡ªç£ç›˜æ§åˆ¶å™¨çš„ä¸­æ–­ **T_IRQ0 + IRQ_IDE**ï¼Œç„¶åè¿›å…¥ **ideintr()** å‡½æ•°:

```
void
ideintr(void)
{
  ...
  if(!(b->flags & B_DIRTY) && idewait(1) >= 0)
    insl(0x1f0, b->data, BSIZE/4);

  b->flags |= B_VALID;
  b->flags &= ~B_DIRTY;
  wakeup(b);

  if(idequeue != 0)
    idestart(idequeue);
  ...
}
```

å¤„ç†æ¥è‡ªç£ç›˜çš„ä¸­æ–­ï¼Œå¯¹åº”é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªbufferï¼Œè¦ä¹ˆæ˜¯ç£ç›˜æ§åˆ¶å™¨ä¸Šæœ‰æ–°çš„æ•°æ®ï¼Œéœ€è¦è¯»å–ï¼Œè¦ä¹ˆæ˜¯å‘Šè¯‰ OS ä¹‹å‰çš„å†™æ“ä½œå·²ç»å®Œæˆï¼Œè¿™å–å†³äºå‰é¢ iderw()-> idestart() æ‰§è¡Œçš„å†™æ“ä½œè¿˜æ˜¯è¯»æ“ä½œã€‚æ‰§è¡Œå®Œ `wakeup(b)` åï¼Œå”¤é†’åœ¨ **iderw()** ä¸­ç¡çœ çš„è¿›ç¨‹ï¼Œæ•´ä¸ª buffer çš„æ“ä½œç»“æŸã€‚

é€šè¿‡ä¸­æ–­çš„æ–¹å¼ï¼Œå¯ä»¥è®©ç­‰å¾…ç£ç›˜æ“ä½œçš„è¿›ç¨‹ç¡çœ ï¼Œè®©å‡ºå¤„ç†å™¨ã€‚è¿™æ˜¯ä¸€ç§æ¯”è¾ƒæœ‰æ•ˆçš„æ–¹å¼ã€‚å¯æ˜¯è¿™ä¸ªè¿›ç¨‹è¿˜æ˜¯ä¼šé˜»å¡åœ¨ **iderw()** å‡½æ•°ã€‚ 

&nbsp;

## ä¸‰ã€Buffer Cache

___

è¿™ä¸€å±‚å”¯ä¸€æ“ä½œçš„æ•°æ®ç»“æ„æ˜¯:

```c
struct {
  struct spinlock lock;
  struct buf buf[NBUF];

  struct buf head;
} bcache;


```

é¦–å…ˆ buffer cache é€šè¿‡ **binit()** å‡½æ•°åˆå§‹åŒ–:

```c
void
binit(void)
{
  struct buf *b;

  initlock(&bcache.lock, "bcache");

  bcache.head.prev = &bcache.head;
  bcache.head.next = &bcache.head;
  for(b = bcache.buf; b < bcache.buf+NBUF; b++){
    b->next = bcache.head.next;
    b->prev = &bcache.head;
    initsleeplock(&b->lock, "buffer");
    bcache.head.next->prev = b;
    bcache.head.next = b;
  }
}
```

å®ƒå°† bcache.buf åˆå§‹åŒ–æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè¿™ä¸ªåŒå‘é“¾è¡¨å®ç°äº† LRU ç®—æ³•ï¼Œåªéœ€çŸ¥é“ bcache.head æ˜¯æœ€å¸¸ä½¿ç”¨çš„ bufferã€‚

è¿™ä¸€å±‚æš´éœ²ç»™ log å±‚çš„å‡½æ•°æœ‰ä¸‰ä¸ª:

```c
struct buf* bread(uint dev, uint blockno);
void bwrite(struct buf *b);
void brelse(struct buf *b);
```

é¦–å…ˆçœ‹ **bread()** å‡½æ•°:

```c
struct buf*
bread(uint dev, uint blockno)
{
  struct buf *b;
  b = bget(dev, blockno);
  if((b->flags & B_VALID) == 0) {
    iderw(b);
  }
  return b;
}
```

è¿™ä¸ªå‡½æ•°å®ç°çš„å…³é”®åœ¨äº **bget()**:

```c
static struct buf* bget(uint dev, uint blockno)
{
  struct buf *b;
  acquire(&bcache.lock);
  for(b = bcache.head.next; b != &bcache.head; b = b->next){
    if(b->dev == dev && b->blockno == blockno){
      b->refcnt++;
      release(&bcache.lock);
      acquiresleep(&b->lock);
      return b;
    }
  }
  for(b = bcache.head.prev; b != &bcache.head; b = b->prev){
    if(b->refcnt == 0 && (b->flags & B_DIRTY) == 0) {
      b->dev = dev;
      b->blockno = blockno;
      b->flags = 0;
      b->refcnt = 1;
      release(&bcache.lock);
      acquiresleep(&b->lock);
      return b;
    }
  }
  panic("bget: no buffers");
}
```

è¿™ä¸ªå‡½æ•°éå† bcache.buf åŒå‘é“¾è¡¨ï¼Œå…ˆä» bcache.head èµ·ï¼Œæ­£å‘æŸ¥æ‰¾é“¾è¡¨(è¿™é‡Œåˆ©ç”¨äº†ç¨‹åºçš„å±€éƒ¨æ€§åŸç†)ã€‚çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°æŒ‡å®šå‚æ•°çš„ block çš„ç¼“å­˜(ç¬¬ä¸€ä¸ªforå¾ªç¯)ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œå†åå‘æŸ¥æ‰¾é“¾è¡¨(ç¬¬äºŒä¸ªforå¾ªç¯)ï¼Œæ‰¾åˆ°ä¸€ä¸ªb->refcntä¸º0ï¼Œä¸”æ•°æ®ä¸ç£ç›˜åŒæ­¥ bufferï¼Œå°†è¿™ä¸ª buffer è®¾ç½®ä¸ºæ–°çš„å‚æ•°ï¼Œå¹¶è¿”å›ã€‚æ³¨æ„è¿”å›ä¹‹å‰è¦å¯¹ buffer åŠ é”

å½“æˆ‘ä»¬ä½¿ç”¨ bread() æ‹¿åˆ°æŸä¸ª block çš„ buffer åï¼Œæœ‰å¯èƒ½å¯¹å…¶æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚ä¿®æ”¹å®Œåï¼Œè°ƒç”¨ bwrite() å°† buffer ä¸­çš„ä¿®æ”¹å†™å›åˆ°ç£ç›˜ï¼Œæœ€åè°ƒç”¨ brealse()ï¼Œè¡¨æ˜å¯¹ buffer çš„æ“ä½œå·²ç»ç»“æŸã€‚

é€šå¸¸å¯¹è¿™ä¸€å±‚çš„æ¥å£æœ‰ä¸‹é¢ä¸¤ç§å½¢å¼çš„è°ƒç”¨:

```
+-------+      +--------+
| bread +----->+ brelse |
+-------+      +--------+

+-------+      +--------+     +--------+     +--------+
| bread +----->+ update +---->+ bwrite +---->+ brelse |
+-------+      +--------+     +--------+     +--------+
```

æ³¨æ„ï¼Œè·å–é”çš„æ“ä½œéƒ½éšè—åœ¨äº† bread() ä¸ brelse() ä¸­ã€‚è°ƒç”¨ brelse() åå°±ä¸èƒ½å†å¯¹åŒä¸€ä¸ª buffer è¿›è¡Œæ“ä½œäº†ã€‚

&nbsp;

## å››ã€Log

___

åœ¨ log å±‚ï¼Œä¸¤ä¸ªé‡è¦çš„ç»“æ„æ˜¯:

```c
struct logheader {
  int n;
  int block[LOGSIZE];
};

struct log {
  struct spinlock lock;
  int start;
  int size;
  int outstanding;
  int committing;
  int dev;
  struct logheader lh;
};
struct log log;
```

è¯¥å±‚æš´éœ²åœ¨å¤–çš„æ¥å£æœ‰:

```c
void begin_op(void);
void log_write(struct buf *b);
void end_op(void);
void initlog(int dev);
```

åœ¨ xv6 ä¸­ï¼Œä¸€ä¸ªæ–‡ä»¶æ“ä½œå¤§è‡´æ˜¯å¦‚ä¸‹é¡ºåº:

```c
begin_op(); 
...
bp1 = bread(); 
bp1->data[] = ...; 
log_write(bp1); 
brelse(bp1);
...
end_op()
```

é¦–å…ˆä½¿ç”¨ begin_op():

```c
void
begin_op(void)
{
  acquire(&log.lock);
  while(1){
      ...
      log.outstanding += 1;
      ...
    }
  }
}
```

è¯´æ˜å³å°†å¼€å§‹å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œåœ¨ log åŒºä¸ºé¢„ç•™ä¸€å—åŒºåŸŸ(log.outstanding += 1)å­˜æ”¾ logã€‚ç„¶åå¼€å§‹å¯¹ buffer è¿›è¡Œä¿®æ”¹ã€‚ä¸ buffer cache å±‚æ¦‚å¿µä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œä¸ä¼šç«‹åˆ»è°ƒç”¨ bwrite() å°†ä¿®æ”¹å†™å›ç£ç›˜å¿«(è¿™æ ·å°±è¾¾ä¸åˆ°logçš„ç›®çš„äº†)ï¼Œè€Œæ˜¯ä½¿ç”¨äº† **log_write()**:

```c
void
log_write(struct buf *b)
{
  ...
  log.lh.block[i] = b->blockno;
  ...
}
```

åœ¨ logheader ä¸­è®°å½•ä¸‹å¯¹å“ªäº› block è¿›è¡Œäº†ä¿®æ”¹ã€‚ç„¶åè°ƒç”¨ **end_op()**ï¼Œè¿™ä¸ªå‡½æ•°ç»è¿‡ä¸€ç³»åˆ—çš„åˆ¤æ–­åï¼Œæœ€ç»ˆæ‰§è¡Œ **commit()**:

```c
static void commit()
{
  if (log.lh.n > 0) {
    write_log();    
    write_head();   
    install_trans();
    log.lh.n = 0;
    write_head();   
  }
}
```

è°ƒç”¨ write_log():

```c
static void write_log(void)
{
  int tail;
  for (tail = 0; tail < log.lh.n; tail++) {
    struct buf *to = bread(log.dev, log.start+tail+1);
    struct buf *from = bread(log.dev, log.lh.block[tail]);
    memmove(to->data, from->data, BSIZE);
    bwrite(to);  // write the log
    brelse(from);
    brelse(to);
  }
}
```

å…ˆå°†æ‰€æœ‰çš„ä¿®æ”¹å­˜æ”¾åˆ° log åŒº(ç´§è·Ÿç€logheader)ã€‚ç„¶åè°ƒç”¨ write_head():

```c
static void write_head(void)
{
  struct buf *buf = bread(log.dev, log.start);
  struct logheader *hb = (struct logheader *) (buf->data);
  int i;
  hb->n = log.lh.n;
  for (i = 0; i < log.lh.n; i++) {
    hb->block[i] = log.lh.block[i];
  }
  bwrite(buf);
  brelse(buf);
}
```

å°†ä¹‹å‰è®°å½•çš„ä¿®æ”¹è¿‡çš„ block å·å­˜è¿›ç£ç›˜ä¸Šçš„ **logheader.block[]** ä¸­ã€‚æ¥ç€è°ƒç”¨ install_trans:

```c
static void install_trans(void)
{
  int tail;
  for (tail = 0; tail < log.lh.n; tail++) {
    struct buf *lbuf = bread(log.dev, log.start+tail+1); 
    struct buf *dbuf = bread(log.dev, log.lh.block[tail]);
    memmove(dbuf->data, lbuf->data, BSIZE);
    bwrite(dbuf);  // write dst to disk
    brelse(lbuf);
    brelse(dbuf);
  }
}
```

æœ€ç»ˆå°† log ä¸­æš‚å­˜çš„ä¿®æ”¹å†™å…¥å®ƒä»¬åœ¨ç£ç›˜ä¸ŠåŸæœ¬çš„åœ°æ–¹ã€‚æœ€åæ‰§è¡Œ:

```c
log.lh.n = 0;
write_head();
```

å°† log æ ‡è®°ä¸ºç©ºã€‚æ•´ä¸ªè¿‡ç¨‹ç±»ä¼¼äº:

![](http://ww1.sinaimg.cn/large/c9caade4gy1g48173sr7wj21640ecq45.jpg)

&nbsp;

## äº”ã€Inode

___

è¿™ä¸€å±‚æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå…³é”®çš„ç»“æ„:

```
struct inode {
  uint dev;           // Device number
  uint inum;          // Inode number
  int ref;            /*è¡¨æ˜æœ‰å¤šå°‘ä¸ª C æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªinodeï¼Œåªæœ‰è¿™ä¸ªæ•°ä¸ä¸ºé›¶æ—¶ï¼Œ
                       *inodeæ‰å­˜åœ¨äºå†…å­˜ä¸­ï¼Œiget()å’Œiput()ä¿®æ”¹å®ƒ
                       *è¿™ä¸ªæŒ‡é’ˆæ¥è‡ª file descriptorï¼Œcurrent working directoryï¼Œæˆ–è€…exec()å‡½æ•°
                       */
  struct sleeplock lock; // protects everything below here
  int valid;          // inode has been read from disk?
  
  // copy of disk inode
  short type;         // File type  dinode free:0   T_DIR:1   T_FILE:2   T_DEV:3
  short major;
  short minor;
  short nlink;        /*è¡¨æ˜æœ‰å¤šå°‘ä¸ª directory entry é“¾æ¥åˆ° inodeï¼Œå½“è¿™ä¸ªæ•°ä¸º 0 æ—¶ï¼Œtypeä¹Ÿç­‰äº0*/
  uint size;
  uint addrs[NDIRECT+1];
};
```

```
// On-disk inode structure
struct dinode {
  short type;           // File type  dinode free:0   T_DIR:1   T_FILE:2   T_DEV:3
  short major;          // Major device number (T_DEV only)
  short minor;          // Minor device number (T_DEV only)
  short nlink;          /*è¡¨æ˜æœ‰å¤šå°‘ä¸ª directory entry é“¾æ¥åˆ° inodeï¼Œå½“è¿™ä¸ªæ•°ä¸º 0 æ—¶ï¼Œtypeä¹Ÿç­‰äº0*/
  uint size;            /*inodeæ‰€è¡¨ç¤ºæ–‡ä»¶å­—èŠ‚æ•°*/
  uint addrs[NDIRECT+1];   /*è¡¨æ˜inodeè¡¨ç¤ºçš„æ–‡ä»¶å†…å®¹éƒ½åœ¨å“ªäº›blockä¸­*/
};
```

è¿™ä¸¤ä¸ªç»“æ„éƒ¨åˆ†å†…å®¹æ˜¯ç›¸åŒçš„ï¼Œdinode è¢«æ‹·è´åˆ°å†…å­˜å­˜æ”¾åœ¨ inode ä¸­ã€‚

inode æè¿°äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹é€šè¿‡ dinode.addrs[] æè¿°ï¼Œå®ƒä»¬æŒ‡å‘ data blockï¼Œå…¶ä½™çš„æˆå‘˜åˆ™æè¿°äº†æ–‡ä»¶çš„å…ƒæ•°æ®:

![](http://ww1.sinaimg.cn/large/c9caade4ly1g49rt6jltaj218q0xkwkz.jpg)

inodes é¡ºåºçš„åˆ†å¸ƒåœ¨ç£ç›˜ä¸Šï¼Œèµ·å§‹ä½ç½®ä¸º superblock.startinodeã€‚ä¸æ™®é€šçš„ data block ä¸€æ ·ï¼ŒOS å°†ä¸€äº›å¸¸ç”¨çš„ inode å­˜æ”¾åœ¨å†…å­˜:

```c
struct {
  struct spinlock lock;
  struct inode inode[NINODE];
} icache;
```

å› ä¸ºå­˜åœ¨å¤šä¸ªè¿›ç¨‹ä½¿ç”¨åŒä¸€ä¸ª inode çš„æƒ…å†µï¼Œæ‰€ä»¥ in-memory inode çš„å¦ä¸€ä¸ªä½œç”¨æ˜¯åŒæ­¥ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ fs.c(æ–‡ä»¶ç³»ç»Ÿ) ä¸­å¯¹å¤–çš„æ¥å£:

```c
// inode
static struct inode* iget(uint dev, uint inum); ğŸ‘Œ
void iinit(int dev); ğŸ‘Œ
struct inode* ialloc(uint dev, short type);
void iupdate(struct inode *ip);
struct inode* idup(struct inode *ip);
void ilock(struct inode *ip);
void iunlock(struct inode *ip);
void iput(struct inode *ip);
void iunlockput(struct inode *ip);

//inode-content
static uint bmap(struct inode *ip, uint bn);
static void itrunc(struct inode *ip);
void stati(struct inode *ip, struct stat *st);
int readi(struct inode *ip, char *dst, uint off, uint n);
int writei(struct inode *ip, char *src, uint off, uint n);

// directory
int namecmp(const char *s, const char *t);
struct inode* dirlookup(struct inode *dp, char *name, uint *poff);
int dirlink(struct inode *dp, char *name, uint inum);

// path
static char* skipelem(char *path, char *name);
static struct inode* namex(char *path, int nameiparent, char *name);
struct inode* namei(char *path);
struct inode* nameiparent(char *path, char *name);
```

ä¸‹é¢é€‰æ‹©åˆé€‚çš„é¡ºåºï¼Œå¯¹å…¶ä¸­é‡è¦çš„å‡½æ•°ä¾æ¬¡ä»‹ç»:

```c
static struct inode* iget(uint dev, uint inum)
{
  ...
  ip = &icache.inode[i];
  if(ip->ref > 0 && ip->dev == dev && ip->inum == inum){
    ip->ref++;
    return ip;
  }
  ...
}
```

è¿™ä¸ªå‡½æ•°æ‰¾åˆ°ä¸€ä¸ªè¿”å›ä¸€ä¸ªæŒ‡å®šå‚æ•°çš„ inode æŒ‡é’ˆã€‚inum æ˜¯ inode åœ¨ç£ç›˜ inode åŒºåŸŸçš„åºå·ã€‚ç„¶åæ‰§è¡Œ:

```c
struct inode* ialloc(uint dev, short type)
{
  ...
  for(inum = 1; inum < sb.ninodes; inum++){
    bp = bread(dev, IBLOCK(inum, sb));
    dip = (struct dinode*)bp->data + inum%IPB;
    if(dip->type == 0){  
      memset(dip, 0, sizeof(*dip));
      dip->type = type;
      log_write(bp);  
      brelse(bp);
      return iget(dev, inum);
    }
    brelse(bp);
  }
  panic("ialloc: no inodes");
}
```

è¿™ä¸ªå‡½æ•°å°†ä¸€ä¸ªç©ºé—²çš„ inode æ ‡è®°ä¸ºä½¿ç”¨ï¼Œå†åœ¨ icache.inode[] é‡Œæ‰¾ä¸€ä¸ªæ§½ä¸ä¹‹å¯¹åº”ã€‚è¿™æ—¶ç£ç›˜ä¸Šçš„ dinode ä¸å†…å­˜ä¸­çš„ inode åªæ˜¯ç®€å•çš„å»ºç«‹äº†æ˜ å°„å…³ç³»ï¼Œå®ƒä»¬çš„å†…å®¹å¹¶æ²¡æœ‰è”ç³»ã€‚è€Œä¸”ç”± **ialloc()** è¿”å›çš„ inode æ²¡æœ‰åŠ é”ï¼Œå¹¶ä¸èƒ½æ’å®ƒçš„ä½¿ç”¨ã€‚æ‰€ä»¥è¿™æ—¶åº”è¯¥ä½¿ç”¨ **ilock()** å‡½æ•°:

```

```
