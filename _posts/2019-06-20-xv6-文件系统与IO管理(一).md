---
layout: post
title: "xv6: 文件系统与I/O管理(一)"
comments: true
description: "xv6: 文件系统与I/O管理(一)"
keywords: "OS, xv6, c, file system, I/O"
---

&nbsp;

## 一、文件与文件系统

___

### 1.1 文件

文件是永久存储 user/kernel 代码和数据的地方，文件通常存储在磁盘上。

文件除了在磁盘上存储文件内容，还会存一些文件的 metadata(元数据): 

- name
- location in a directory structure
- location on disk
- file type
- access permissions
- modification time
- file size
- so on

和一些文件操作:

- create
- read
- write/update
- delete
- rename
- truncate
- append
- seek

大多数编程语言都会提供一些库，来完成上述操作。

### 1.2 目录

多个文件通常组织在目录下，目录的内容包括一些文件和这些文件的愿数据，大多数 OS 把目录当作特殊的文件。文件与目录组织起来就像一棵树，OS 可以对这棵树的深度等进行设置。

文件和目录的数据和元数据存放在磁盘或者内存中。**文件的数据存放在磁盘上的 block 里，文件的元数据存放在 inode 数据结构里**。一个 inode 唯一标识一个文件。使用文件时，就拷贝一份该文件的 inode(on-disk inode) 到内存中。在内存中的 inode 通常称为 in-memory inode（这是另外一个数据结构）。在 xv6 中这两个数据结构分别如下:

```
// in-memory copy of an inode
struct inode {
  uint dev;           // Device number
  uint inum;          // Inode number
  int ref;            // Reference count
  struct sleeplock lock; // protects everything below here
  int valid;          // inode has been read from disk?

  short type;         // copy of disk inode
  short major;
  short minor;
  short nlink;
  uint size;
  uint addrs[NDIRECT+1];
};

// On-disk inode structure
struct dinode {
  short type;           // File type
  short major;          // Major device number (T_DEV only)
  short minor;          // Minor device number (T_DEV only)
  short nlink;          // Number of links to inode in file system
  uint size;            // Size of file (bytes)
  uint addrs[NDIRECT+1];   // Data block addresses
};
```

可以看到 inode 比 dinode 多了一些信息。在 xv6 中，in-memory inodes 保存在另一个数据结构中:

```
struct {
  struct spinlock lock;
  struct inode inode[NINODE]; // NINODE=50
} icache;
```

在 xv6 中，有一个目录项（directory entry）数据结构如下所示:

```c
struct dirent {
  ushort inum;
  char name[DIRSIZ]; // DIRSIZ =
};
```

目录项将一个目录中的文件链接到它的 inode。也就是说，目录项存放着该目录下文件到 inode 到映射关系。目录项以什么方式存放在磁盘上，这取决于 OS 的实现。

大多数 OS 支持在不同的目录下建立目录项，并链接到同一个 inode。这样的链接方式有两种:

- Hard Linking: a directory entry in the new disk location is created to map a new file name and an existing inode number.
- Soft Linking: a new directory entry is created to only map a new file name to the old file name, and the old file name must be looked up (if it exists) to locate the inode number.

```
+-----------+     +-------+      +-----------+
| hard link |     | a.txt |<-----+ soft link |
+-----+-----+     +---+---+      +-----------+
      |               |
      |               |
      |               |
      |               v
      |           +---+---+
      +---------->| inode |
                  +-------+
```

软链接和硬链接的具体区别可以参考[这里](https://stackoverflow.com/questions/185899/what-is-the-difference-between-a-symbolic-link-and-a-hard-link)。这里摘录一句很经典到解释:

> A file in the file system is basically **a link** to an inode. A hard link then just creates another file(link) with a link to the same underlying inode.

文件（这里理解为 inode 更为准确）在创建之初默认链接到它到父目录。接下来可能还会有更多到 directory entry 硬链接到这个 inode，这样一来，通过不同到文件名链接到同一个 inode。在 in-memory inode 中使用 `inode.nlink` 这个成员来记住链接数量。

A file is garbage collected only when (1)it is unlinked from all its parents and (2)its **link count** reaches zero.

注意这里 **link count** 不包括软链接。




参考资料: 

- [What is the difference between a symbolic link and a hard link?](https://stackoverflow.com/questions/185899/what-is-the-difference-between-a-symbolic-link-and-a-hard-link)




