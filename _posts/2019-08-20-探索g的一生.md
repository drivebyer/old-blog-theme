---
layout: post
title: '探索g的一生'
subtitle: 'g的创建，p的状态切换'
date: 2019-08-20
categories: 技术
cover: ''
tags: Golang
---

环境：
```go
$ go version
go version go1.12.7 linux/amd64
$ uname -a
Linux wu-insparition 4.18.0-25-generic #26~18.04.1-Ubuntu SMP Thu Jun 27 07:28:31 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
```

在runtime中，通过`new(g)`语句在堆上分配一个g，整个runtime中唯一调用`new(g)`的函数是`malg()`：
```go
func malg(stacksize int32) *g {
	newg := new(g)
	if stacksize >= 0 {
        stacksize = round2(_StackSystem + stacksize)
        /*
            必须在g0栈上分配
        */
		systemstack(func() {
            newg.stack = stackalloc(uint32(stacksize))
		})
		newg.stackguard0 = newg.stack.lo + _StackGuard
		newg.stackguard1 = ^uintptr(0)
	}
	return newg
}
```

![g状态变迁](http://ww1.sinaimg.cn/large/c9caade4gy1g66g3tbu1uj21kq0y0dmg.jpg)
