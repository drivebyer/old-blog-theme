---
layout: post
title: '探索g的一生'
subtitle: 'g的创建，p的状态切换'
date: 2019-08-20
categories: 技术
cover: ''
tags: Golang
---

环境：
```go
$ go version
go version go1.12.7 linux/amd64
$ uname -a
18.04.1-Ubuntu SMP x86_64 x86_64 x86_64 GNU/Linux
```

在runtime中，通过`new(g)`语句在堆上分配一个g，整个runtime中唯一调用`new(g)`的函数是`malg()`：
```go
func malg(stacksize int32) *g {
	newg := new(g)
	if stacksize >= 0 {
        stacksize = round2(_StackSystem + stacksize)
        /*
            必须在g0栈上分配
        */
		systemstack(func() {
            newg.stack = stackalloc(uint32(stacksize))
		})
		newg.stackguard0 = newg.stack.lo + _StackGuard
		newg.stackguard1 = ^uintptr(0)
	}
	return newg
}
```
在runtime中，通过malg函数的调用目的，可将goroutine分为4类：
- mp.g0 = malg(-1)，与linux无关
- extram上m的goroutine，malg(4096)
- mp.g0 = malg(8192 * sys.StackGuardMultiplier)，linux等系统上的g0
- malg(_StackMin)，普通goroutine，栈大小为2KB

这里着重介绍最后一种goroutine。在go语言中，提供了`go`这个关键字来创建一个goroutine，范例：
```go
package main
import "fmt"
import "time"
func main() {
	i := 69
	j := 100
	go func(arg1, arg2 int){
		fmt.Println(arg1+arg2)
	}(i, j)
	time.Sleep(1*time.Second)
}
```
为了弄清楚goroutine创建的本质，下面的介绍会结合go源码和汇编代码（x86汇编）的形式。
```
$ go build -gcflags '-N -l' gokeyword.go
$ objdump -d gokeyword | grep '<main.main>:' -A 30
```
在执行`callq  4310b0 <runtime.newproc>`前，函数的栈帧大致如下：
```
			 main
          +---------+
          |  .....  |
          +---------+ <-+
          |   rbp   |
      +-+ +---------+ <-+ rbp
      |   |   69    |
local var +---------+
      |   |   100   |
      +-+ +---------+
      |   |   100   |
      |   +---------+
      |   |   69    |
 argument +---------+
      |   |   fn    |
      |   +---------+
      |   |   18    | 参数大小
      +-+ +---------+ <-+ rsp
```
```
$ objdump -d gokeyword | grep '<runtime.newproc>:' -A 30
```
在执行`callq  44f9a0 <runtime.systemstack>`前，栈帧大致如下：
```
        newproc              main
      +--------+           +--------+
      |  rbp   |           |  ...   |
      +--------+           +--------+ <-+
pc    |  ret   |           |  rbp   |
      +--------+           +--------+ +-+
gp    |  TLS   |           |  69    |   |
      +--------+           +--------+   | local var
siz   |  16    |           |  100   |   |
      +--------+           +--------+ +-+
argp  |   |----------+     |  100   |   |
      +--------+     |     +--------+   | argument
fn    |   |-------+  +---> |  69    |   |
      +--------+  |        +--------+ +-+
      |  func1 |  +------> |  fun_  |
      +--------+           +--------+
      |  func1 |           |  16    |
      +--------+ <-+RSP    +--------+
                           |  ret   |
                           +--------+
```


![g状态变迁](http://ww1.sinaimg.cn/large/c9caade4gy1g66g3tbu1uj21kq0y0dmg.jpg)
